# 假设IPs和ports是数组，包含了所有的IP地址和对应的端口
IPs=("137.220.171.40" "137.220.171.60") # 服务器的IP地址列表
ports=(1080 1090) # 对应的端口列表

for i in "${!IPs[@]}"; do
    ip=${IPs[$i]}
    port=${ports[$i]}
    config_file="/etc/socks/config_$ip.yaml"
    service_file="/etc/systemd/system/sockd_$ip.service"

    # 创建配置文件
    cat <<EOF > "$config_file"
{
    "log": {
        "loglevel": "warning"
    },
    "inbounds": [
        {
            "listen": "$ip",
            "port": $port,
            "protocol": "socks",
            "settings": {
                "udp": true
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "tag": "direct"
        },
        {
            "protocol": "blackhole",
            "tag": "block"
        }
    ]
}
EOF

    # 创建服务文件
    cat <<EOF > "$service_file"
[Unit]
Description=Socks Service on $ip
After=network.target nss-lookup.target

[Service]
User=nobody
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
NoNewPrivileges=true
ExecStart=/usr/local/bin/socks run -config "$config_file"
Restart=on-failure
RestartPreventExitStatus=23
LimitNPROC=10000
LimitNOFILE=1000000

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable "sockd_$ip.service"
    systemctl start "sockd_$ip.service"
done
