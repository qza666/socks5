#!/usr/bin/env bash
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin
export PATH

# 字体颜色设置
Green="\033[32m"
Red="\033[31m"
GreenBG="\033[42;37m"
RedBG="\033[41;37m"
Font="\033[0m"

# IP表和端口配置
IPs=("137.220.171.40" "137.220.171.60" "192.168.1.3")  # 示例IP数组
base_port=4000  # 起始端口号

# 检查系统类型和版本
source '/etc/os-release'
OK="${Green}[OK]${Font}"
Error="${Red}[错误]${Font}"

# 判断是否为root用户
if [ 0 -ne $UID ]; then
    echo -e "${Error} ${RedBG} 当前用户不是root用户，请使用 'sudo -i' 切换到root用户后重新执行脚本 ${Font}"
    exit 1
fi

# 检查系统是否支持
check_system() {
    if [[ "${ID}" == "centos" && ${VERSION_ID} -ge 7 ]]; then
        INS="yum"
    elif [[ "${ID}" == "debian" && ${VERSION_ID} -ge 8 ]]; then
        INS="apt-get"
    elif [[ "${ID}" == "ubuntu" && $(echo "${VERSION_ID}" | cut -d '.' -f1) -ge 16 ]]; then
        INS="apt-get"
    else
        echo -e "${Error} ${RedBG} 当前系统 ${ID} ${VERSION_ID} 不支持，安装中断 ${Font}"
        exit 1
    fi
    $INS update -y
    $INS install -y curl
}

# 安装socks5
install_socks5() {
    wget -O /usr/local/bin/socks --no-check-certificate https://github.com/kangcwei/ss5/releases/download/ss5/socks
    chmod +x /usr/local/bin/socks

    # 遍历IP和端口，配置每个服务
    for i in "${!IPs[@]}"; do
        local ip="${IPs[$i]}"
        local port=$((base_port + i))
        
        # 为每个IP创建服务
        cat <<EOF > /etc/systemd/system/sockd-$ip.service
[Unit]
Description=Socks Service for $ip
After=network.target nss-lookup.target

[Service]
User=nobody
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
NoNewPrivileges=true
ExecStart=/usr/local/bin/socks run -config /etc/socks/config-$ip.yaml
Restart=on-failure
RestartPreventExitStatus=23
LimitNPROC=10000
LimitNOFILE=1000000

[Install]
WantedBy=multi-user.target
EOF

        # 创建配置文件
        mkdir -p /etc/socks
        cat <<EOF > /etc/socks/config-$ip.yaml
{
    "log": {
        "loglevel": "warning"
    },
    "inbounds": [
        {
            "listen": "$ip",
            "port": $port,
            "protocol": "socks",
            "settings": {
                "udp": true
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "tag": "direct"
        },
        {
            "protocol": "blackhole",
            "tag": "block"
        }
    ]
}
EOF
        systemctl daemon-reload
        systemctl enable sockd-$ip.service
        systemctl start sockd-$ip.service
        echo "$ip:$port"
    done
}

check_system
install_socks5
